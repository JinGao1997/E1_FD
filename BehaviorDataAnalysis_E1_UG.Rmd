---
title: "UG Task Behavioral Data Analysis"
author: "Jin"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    code_folding: hide
---

``` {r setup, include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(emmeans)
library(car)
knitr::opts_chunk$set(
  echo    = TRUE,
  warning = FALSE,
  message = FALSE
)
options(scipen = 10)
dir.create("analysis_output/results/ratio", recursive = TRUE, showWarnings = FALSE)
dir.create("analysis_output/results/type", recursive = TRUE, showWarnings = FALSE)
````

# 1. 数据导入与变量构建

``` {r import-vars}
data_path <- "E:/PD_E1_UG_jg/EEG_R_Python_Pipeline_JG_Backup/Offers__Behavior/BehaviorDataAnalysis/trials.csv"
df_raw <- read_csv(data_path)
df_raw <- df_raw %>%
  mutate(
    offer_ratio = factor(paste0(Offers_You, ":", Offers_Other),
                         levels = c("5:5", "4:6", "3:7", "2:8", "1:9")),
    # OfferType: 可调整定义
    offer_type = case_when(
      paste0(Offers_You, ":", Offers_Other) %in% c("5:5", "4:6") ~ "fair",
      paste0(Offers_You, ":", Offers_Other) %in% c("2:8", "1:9") ~ "unfair",
      TRUE ~ "other"
    ),
    offer_type = factor(offer_type, levels = c("fair", "unfair", "other")),
    reaction_bin = if_else(reaction == 1, 1L, 0L),
    emotion = factor(emotion, levels = c("dis", "dom", "neu", "aff", "enj")),
    participant_id = factor(participant_id)
  )
glimpse(df_raw)
```

# 2. Ratio分析：**不删掉任何ratio**

``` {r ratio-data}
df_ratio <- df_raw %>%
  filter(RT >= 150, RT <= 3000, !is.na(reaction)) %>%
  filter(!is.na(offer_ratio)) %>%
  mutate(
    offer_ratio = droplevels(offer_ratio),
    # 保留全部ratio水平，不管offer_type
    emotion = droplevels(emotion)
  )
table(df_ratio$emotion, df_ratio$offer_ratio)
```

# 3. Type分析：**只保留fair/unfair**

``` {r type-data}
df_type <- df_raw %>%
  filter(RT >= 150, RT <= 3000, !is.na(reaction)) %>%
  filter(offer_type %in% c("fair", "unfair")) %>%
  mutate(
    offer_type = droplevels(offer_type),
    emotion = droplevels(emotion)
  )
table(df_type$emotion, df_type$offer_type)
```

---

# Part 1. Ratio为自变量

``` {r sum-coding-ratio}
contrasts(df_ratio$emotion)     <- contr.sum(length(levels(df_ratio$emotion)))
contrasts(df_ratio$offer_ratio) <- contr.sum(length(levels(df_ratio$offer_ratio)))
```

## 1. GLMM

``` {r glmm-ratio}
glmm_model_ratio <- glmer(
  reaction_bin ~ emotion * offer_ratio + (1 | participant_id),
  data   = df_ratio,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
)
glmm_anova_ratio <- car::Anova(glmm_model_ratio, type = "III", test.statistic = "Chisq")
glmm_anova_ratio_df <- as.data.frame(glmm_anova_ratio)
glmm_anova_ratio_df$Effect <- rownames(glmm_anova_ratio_df)
glmm_anova_ratio_df <- glmm_anova_ratio_df[, c(ncol(glmm_anova_ratio_df), 1:(ncol(glmm_anova_ratio_df)-1))]
write_csv(glmm_anova_ratio_df, "analysis_output/results/ratio/glmm_anova.csv")
```

## 2. 主效应边际均值

``` {r glmm-marginals-ratio}
emm_e <- emmeans(glmm_model_ratio, ~ emotion, type = "response")
emm_e_eff <- contrast(emm_e, "eff")
emm_o <- emmeans(glmm_model_ratio, ~ offer_ratio, type = "response")
emm_o_eff <- contrast(emm_o, "eff")
glmm_main <- bind_rows(
  as.data.frame(emm_e_eff) %>% mutate(effect = "Emotion"),
  as.data.frame(emm_o_eff) %>% mutate(effect = "OfferRatio")
)
write_csv(glmm_main, "analysis_output/results/ratio/glmm_main_effects.csv")
```

## 3. 后验对比（两两比较）

``` {r glmm-posthoc-ratio}
glmm_ph_by_ratio <- contrast(
  emmeans(glmm_model_ratio, ~ emotion | offer_ratio, type = "response"),
  method = "pairwise", adjust = "bonferroni"
)
write_csv(as.data.frame(summary(glmm_ph_by_ratio)), "analysis_output/results/ratio/glmm_posthoc_by_ratio.csv")
glmm_ph_by_emotion <- contrast(
  emmeans(glmm_model_ratio, ~ offer_ratio | emotion, type = "response"),
  method = "pairwise", adjust = "bonferroni"
)
write_csv(as.data.frame(summary(glmm_ph_by_emotion)), "analysis_output/results/ratio/glmm_posthoc_by_emotion.csv")
```

## 4. 交互预测

``` {r glmm-predictions-ratio}
pred_glmm <- emmeans(glmm_model_ratio, ~ emotion * offer_ratio, type = "response")
pred_df <- as.data.frame(pred_glmm)
write_csv(pred_df, "analysis_output/results/ratio/glmm_interaction_preds.csv")
```

## 5. LMM: RT分析

``` {r lmm-model-ratio}
df_lmm <- df_ratio %>% mutate(logRT = log(RT))
lmm_model_ratio <- lmer(
  logRT ~ emotion * offer_ratio + (1 | participant_id),
  data = df_lmm,
  control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
)
lmm_anova_ratio <- anova(lmm_model_ratio, type = 3)
lmm_anova_ratio_df <- as.data.frame(lmm_anova_ratio)
lmm_anova_ratio_df$Effect <- rownames(lmm_anova_ratio_df)
lmm_anova_ratio_df <- lmm_anova_ratio_df[, c(ncol(lmm_anova_ratio_df), 1:(ncol(lmm_anova_ratio_df)-1))]
write_csv(lmm_anova_ratio_df, "analysis_output/results/ratio/lmm_anova.csv")
```

## 6. 主效应边际均值

``` {r lmm-marginals-ratio}
emm_e_lmm <- emmeans(lmm_model_ratio, ~ emotion)
eff_e_lmm <- contrast(emm_e_lmm, "eff")
emm_o_lmm <- emmeans(lmm_model_ratio, ~ offer_ratio)
eff_o_lmm <- contrast(emm_o_lmm, "eff")
lmm_main <- bind_rows(
  as.data.frame(eff_e_lmm) %>% mutate(effect = "Emotion"),
  as.data.frame(eff_o_lmm) %>% mutate(effect = "OfferRatio")
)
write_csv(lmm_main, "analysis_output/results/ratio/lmm_main_effects.csv")
```

## 7. 后验对比（两两比较）

``` {r lmm-posthoc-ratio}
lmm_ph_by_ratio <- contrast(
  emmeans(lmm_model_ratio, ~ emotion | offer_ratio),
  method = "pairwise", adjust = "bonferroni"
)
write_csv(as.data.frame(summary(lmm_ph_by_ratio)), "analysis_output/results/ratio/lmm_posthoc_by_ratio.csv")
lmm_ph_by_emotion <- contrast(
  emmeans(lmm_model_ratio, ~ offer_ratio | emotion),
  method = "pairwise", adjust = "bonferroni"
)
write_csv(as.data.frame(summary(lmm_ph_by_emotion)), "analysis_output/results/ratio/lmm_posthoc_by_emotion.csv")
```

## 8. 交互预测（反转回毫秒）

``` {r lmm-predictions-ratio}
pred_lmm <- emmeans(lmm_model_ratio, ~ emotion * offer_ratio)
pred_lmm_df <- as.data.frame(pred_lmm) %>%
  rename(logRT_pred = emmean) %>%
  mutate(
    RT_pred_ms = exp(logRT_pred),
    lower_ms   = exp(asymp.LCL),
    upper_ms   = exp(asymp.UCL)
  )
write_csv(pred_lmm_df, "analysis_output/results/ratio/lmm_interaction_preds.csv")
```

---

# Part 2. Type为自变量（仅fair/unfair）

``` {r sum-coding-type}
contrasts(df_type$emotion)     <- contr.sum(length(levels(df_type$emotion)))
contrasts(df_type$offer_type)  <- contr.sum(length(levels(df_type$offer_type)))
```

## 1. GLMM

``` {r glmm-type}
glmm_model_type <- glmer(
  reaction_bin ~ emotion * offer_type + (1 | participant_id),
  data   = df_type,
  family = binomial,
  control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
)
glmm_anova_type <- car::Anova(glmm_model_type, type = "III", test.statistic = "Chisq")
glmm_anova_type_df <- as.data.frame(glmm_anova_type)
glmm_anova_type_df$Effect <- rownames(glmm_anova_type_df)
glmm_anova_type_df <- glmm_anova_type_df[, c(ncol(glmm_anova_type_df), 1:(ncol(glmm_anova_type_df)-1))]
write_csv(glmm_anova_type_df, "analysis_output/results/type/glmm_anova.csv")
```

## 2. 主效应边际均值

``` {r glmm-marginals-type}
emm_e_type <- emmeans(glmm_model_type, ~ emotion, type = "response")
emm_e_eff_type <- contrast(emm_e_type, "eff")
emm_t_type <- emmeans(glmm_model_type, ~ offer_type, type = "response")
emm_t_eff_type <- contrast(emm_t_type, "eff")
glmm_main_type <- bind_rows(
  as.data.frame(emm_e_eff_type) %>% mutate(effect = "Emotion"),
  as.data.frame(emm_t_eff_type) %>% mutate(effect = "OfferType")
)
write_csv(glmm_main_type, "analysis_output/results/type/glmm_main_effects.csv")
```

## 3. 后验对比（两两比较）

``` {r glmm-posthoc-type}
glmm_ph_by_type <- contrast(
  emmeans(glmm_model_type, ~ emotion | offer_type, type = "response"),
  method = "pairwise", adjust = "bonferroni"
)
write_csv(as.data.frame(summary(glmm_ph_by_type)), "analysis_output/results/type/glmm_posthoc_by_type.csv")
glmm_ph_by_emotion_type <- contrast(
  emmeans(glmm_model_type, ~ offer_type | emotion, type = "response"),
  method = "pairwise", adjust = "bonferroni"
)
write_csv(as.data.frame(summary(glmm_ph_by_emotion_type)), "analysis_output/results/type/glmm_posthoc_by_emotion.csv")
```

## 4. 交互预测

``` {r glmm-predictions-type}
pred_glmm_type <- emmeans(glmm_model_type, ~ emotion * offer_type, type = "response")
pred_df_type <- as.data.frame(pred_glmm_type)
write_csv(pred_df_type, "analysis_output/results/type/glmm_interaction_preds.csv")
```

## 5. LMM: RT分析

``` {r lmm-model-type}
df_lmm_type <- df_type %>% mutate(logRT = log(RT))
lmm_model_type <- lmer(
  logRT ~ emotion * offer_type + (1 | participant_id),
  data = df_lmm_type,
  control = lmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
)
lmm_anova_type <- anova(lmm_model_type, type = 3)
lmm_anova_type_df <- as.data.frame(lmm_anova_type)
lmm_anova_type_df$Effect <- rownames(lmm_anova_type_df)
lmm_anova_type_df <- lmm_anova_type_df[, c(ncol(lmm_anova_type_df), 1:(ncol(lmm_anova_type_df)-1))]
write_csv(lmm_anova_type_df, "analysis_output/results/type/lmm_anova.csv")
```

## 6. 主效应边际均值

``` {r lmm-marginals-type}
emm_e_lmm_type <- emmeans(lmm_model_type, ~ emotion)
eff_e_lmm_type <- contrast(emm_e_lmm_type, "eff")
emm_t_lmm_type <- emmeans(lmm_model_type, ~ offer_type)
eff_t_lmm_type <- contrast(emm_t_lmm_type, "eff")
lmm_main_type <- bind_rows(
  as.data.frame(eff_e_lmm_type) %>% mutate(effect = "Emotion"),
  as.data.frame(eff_t_lmm_type) %>% mutate(effect = "OfferType")
)
write_csv(lmm_main_type, "analysis_output/results/type/lmm_main_effects.csv")
```

## 7. 后验对比（两两比较）

``` {r lmm-posthoc-type}
lmm_ph_by_type <- contrast(
  emmeans(lmm_model_type, ~ emotion | offer_type),
  method = "pairwise", adjust = "bonferroni"
)
write_csv(as.data.frame(summary(lmm_ph_by_type)), "analysis_output/results/type/lmm_posthoc_by_type.csv")
lmm_ph_by_emotion_type <- contrast(
  emmeans(lmm_model_type, ~ offer_type | emotion),
  method = "pairwise", adjust = "bonferroni"
)
write_csv(as.data.frame(summary(lmm_ph_by_emotion_type)), "analysis_output/results/type/lmm_posthoc_by_emotion.csv")
```

## 8. 交互预测（反转回毫秒）

``` {r lmm-predictions-type}
pred_lmm_type <- emmeans(lmm_model_type, ~ emotion * offer_type)
pred_lmm_type_df <- as.data.frame(pred_lmm_type) %>%
  rename(logRT_pred = emmean) %>%
  mutate(
    RT_pred_ms = exp(logRT_pred),
    lower_ms   = exp(asymp.LCL),
    upper_ms   = exp(asymp.UCL)
  )
write_csv(pred_lmm_type_df, "analysis_output/results/type/lmm_interaction_preds.csv")
```

# 结尾：Session Info

``` {r session-info}
sessionInfo()
```

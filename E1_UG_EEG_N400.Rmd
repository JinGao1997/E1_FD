---
title: "N400 Component Analysis: Complete Statistical Framework"
author: "Your Name"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

``` {r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# 设置工作目录
setwd("D:/PD_E1_UG_jg/EEG_R_Python_Pipeline_JG_Backup/E1_UG")

library(reticulate)
use_condaenv("r-reticulate", required = TRUE)

# 强制加载本地pipeline并修复问题
py_run_string("
import sys
import os
import re

# 清理所有已加载的pipeline模块
pipeline_modules = [key for key in list(sys.modules.keys()) if 'pipeline' in key]
for module in pipeline_modules:
    del sys.modules[module]
print(f'Cleared {len(pipeline_modules)} pipeline modules')

# 添加本地路径到最前面
local_path = r'D:\\PD_E1_UG_jg\\EEG_R_Python_Pipeline_JG_Backup\\hu-neuro-pipeline'
if local_path in sys.path:
    sys.path.remove(local_path)
sys.path.insert(0, local_path)

# 导入pipeline
import pipeline
print(f'Pipeline loaded from: {pipeline.__file__}')

# 修复epoching.py中的事件标记问题
from pipeline import epoching

def get_events_fixed(raw, triggers):
    '''修复版本：处理S格式的事件标记'''
    from mne import events_from_annotations
    
    events, event_id = events_from_annotations(raw)
    
    # 从事件标记提取数字
    def extract_number(key):
        match = re.search(r'\\d+', str(key))
        return int(match.group()) if match else None
    
    # 过滤事件
    filtered_event_id = {}
    for key, value in event_id.items():
        trigger_num = extract_number(key)
        if trigger_num and trigger_num in triggers:
            filtered_event_id[key] = value
    
    return events, filtered_event_id

# 替换原函数
epoching.get_events = get_events_fixed
print('Applied event extraction fix')
")

pipeline <- import("pipeline")
```

# 1. Load Required Packages

``` {r packages}
# 基础包
library(tidyverse)
library(ggplot2)
library(dplyr)
library(readr)
library(stringr)

# 统计包
library(lme4)
library(lmerTest)
library(afex)
afex_options(emmeans_model = "multivariate") # 设置emmeans选项
library(emmeans)
library(performance)
library(effectsize)
library(parameters)
library(car)
library(gridExtra)
library(ggpubr)
```

# 2. Data Preprocessing

``` {r preprocess-logs, include=FALSE}
orig_logs <- list.files("data/csv_all", pattern = "\\.txt$", full.names = TRUE)
out_dir <- "data/csv_filtered"
out_summary <- "data/csv_summaryPostRating"
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)
dir.create(out_summary, showWarnings = FALSE, recursive = TRUE)

for (fpath in orig_logs) {
  fb <- file(fpath, "rb")
  bom <- readBin(fb, "raw", n = 2)
  close(fb)
  encoding <- if(length(bom) == 2 && identical(bom, as.raw(c(0xFF, 0xFE)))) "UTF-16LE" else "UTF-8"
  
  df <- read_delim(fpath, delim = "\t", col_types = cols(), 
                   show_col_types = FALSE, locale = locale(encoding = encoding))
  
  n <- nrow(df)
  df_trials <- df %>% slice(1:(n-3)) %>% filter(block != 7) %>%
    mutate(emotion = str_extract(stim, "enj|dis|dom|neu|aff"))
  df_summary <- df %>% slice((n-2):n)
  
  out_name <- paste0(tools::file_path_sans_ext(basename(fpath)), ".csv")
  out_name_summary <- paste0(tools::file_path_sans_ext(basename(fpath)), "_summaryPostRating.csv")
  write_csv(df_trials, file.path(out_dir, out_name))
  write_csv(df_summary, file.path(out_summary, out_name_summary))
}
```

# 3. N400 Component Extraction

``` {r n400-extraction}
res_n400 <- pipeline$group_pipeline(
  raw_files     = "data/raw_all_cropped",
  log_files     = "data/csv_filtered",
  output_dir    = "export/n400_analysis",
  ica_method    = "fastica",
  ica_n_components = 0.99,
  triggers      = c(10:89, 150:169),
  bad_channels  = "auto",
  highpass_freq = 0.05,
  lowpass_freq  = 30.0,
  reject_peak_to_peak= 200.0,
  components    = list(
    name = list("N400"),
    tmin = list(0.350),
    tmax = list(0.450),
    roi  = list(c("Fz","Cz","CPz","Pz"))
  ),
  average_by = list(
    Face_enj_5_5 = "emotion=='enj' & Offers_Other==5 & Offers_You==5 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_dis_5_5 = "emotion=='dis' & Offers_Other==5 & Offers_You==5 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_dom_5_5 = "emotion=='dom' & Offers_Other==5 & Offers_You==5 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_neu_5_5 = "emotion=='neu' & Offers_Other==5 & Offers_You==5 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_aff_5_5 = "emotion=='aff' & Offers_Other==5 & Offers_You==5 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_enj_6_4 = "emotion=='enj' & Offers_Other==6 & Offers_You==4 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_dis_6_4 = "emotion=='dis' & Offers_Other==6 & Offers_You==4 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_dom_6_4 = "emotion=='dom' & Offers_Other==6 & Offers_You==4 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_neu_6_4 = "emotion=='neu' & Offers_Other==6 & Offers_You==4 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_aff_6_4 = "emotion=='aff' & Offers_Other==6 & Offers_You==4 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_enj_7_3 = "emotion=='enj' & Offers_Other==7 & Offers_You==3 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_dis_7_3 = "emotion=='dis' & Offers_Other==7 & Offers_You==3 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_dom_7_3 = "emotion=='dom' & Offers_Other==7 & Offers_You==3 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_neu_7_3 = "emotion=='neu' & Offers_Other==7 & Offers_You==3 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_aff_7_3 = "emotion=='aff' & Offers_Other==7 & Offers_You==3 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_enj_8_2 = "emotion=='enj' & Offers_Other==8 & Offers_You==2 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_dis_8_2 = "emotion=='dis' & Offers_Other==8 & Offers_You==2 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_dom_8_2 = "emotion=='dom' & Offers_Other==8 & Offers_You==2 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_neu_8_2 = "emotion=='neu' & Offers_Other==8 & Offers_You==2 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_aff_8_2 = "emotion=='aff' & Offers_Other==8 & Offers_You==2 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_enj_9_1 = "emotion=='enj' & Offers_Other==9 & Offers_You==1 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_dis_9_1 = "emotion=='dis' & Offers_Other==9 & Offers_You==1 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_dom_9_1 = "emotion=='dom' & Offers_Other==9 & Offers_You==1 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_neu_9_1 = "emotion=='neu' & Offers_Other==9 & Offers_You==1 & reaction>0 & RT >= 150 & RT <= 3000",
    Face_aff_9_1 = "emotion=='aff' & Offers_Other==9 & Offers_You==1 & reaction>0 & RT >= 150 & RT <= 3000"
  )
)

trials_n400  <- res_n400[[1]]
evokeds_n400 <- res_n400[[2]]
config_n400  <- res_n400[[3]]

cat("N400 extraction completed!\n")
```